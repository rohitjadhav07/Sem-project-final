{% extends "base.html" %}

{% block title %}Active Lectures - GPS Check-in{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-broadcast-tower"></i> Active Lectures</h2>
                    <p class="text-muted">Use GPS to mark your attendance for ongoing lectures</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if lectures %}
        <div class="row">
            {% for lecture in lectures %}
            <div class="col-md-6 mb-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ lecture.course.code if lecture.course else 'Unknown Course' }}</h6>
                            <span class="badge bg-light text-success">Check-in Available</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">{{ lecture.title }}</h6>
                        <p class="card-text">{{ lecture.description or 'No description available' }}</p>
                        
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted">Start Time</small>
                                <br><strong>{{ lecture.scheduled_start.strftime('%H:%M') if lecture.scheduled_start else 'N/A' }}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">End Time</small>
                                <br><strong>{{ lecture.scheduled_end.strftime('%H:%M') if lecture.scheduled_end else 'N/A' }}</strong>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> {{ lecture.location_name or 'Location not specified' }}
                            </small>
                            <br><small class="text-muted">GPS Coordinates: {{ lecture.latitude }}, {{ lecture.longitude }}</small>
                            <br><small class="text-muted">Required: Within {{ lecture.geofence_radius or 50 }} meters</small>
                        </div>
                        
                        <div class="d-grid">
                            <button class="btn btn-success btn-lg" 
                                    onclick="startGPSCheckin({{ lecture.id }}, '{{ lecture.title }}', {{ lecture.latitude }}, {{ lecture.longitude }}, {{ lecture.geofence_radius or 50 }})">
                                <i class="fas fa-satellite-dish"></i> GPS Check-in
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle fa-3x mb-3"></i>
            <h5>No Active Lectures</h5>
            <p>There are no lectures available for check-in at the moment.</p>
            <button class="btn btn-outline-primary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    {% endif %}

    {% if upcoming_lectures %}
        <div class="row mt-5">
            <div class="col-12">
                <h4 class="text-warning"><i class="fas fa-clock"></i> Upcoming Today</h4>
            </div>
            {% for item in upcoming_lectures %}
            <div class="col-md-6 mb-3">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">{{ item.course.code if item.course else 'Unknown Course' }} - {{ item.title }}</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Starts:</strong> {{ item.scheduled_start.strftime('%H:%M') if item.scheduled_start else 'N/A' }}</p>
                        <p><strong>Check-in opens:</strong> {{ item.checkin_opens_at.strftime('%H:%M') if item.checkin_opens_at else 'N/A' }}</p>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> Check-in will be available soon.</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if completed_lectures %}
        <div class="row mt-5">
            <div class="col-12">
                <h4 class="text-secondary"><i class="fas fa-history"></i> Today's Completed</h4>
            </div>
            {% for item in completed_lectures %}
            <div class="col-md-6 mb-3">
                <div class="card border-secondary">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">{{ item.lecture.course.code if item.lecture.course else 'Unknown Course' }} - {{ item.lecture.title }}</h6>
                    </div>
                    <div class="card-body">
                        {% if item.attendance %}
                            <div class="alert alert-success">
                                <i class="fas fa-check"></i> <strong>Attended</strong><br>
                                <small>Marked at: {{ item.attendance.marked_at.strftime('%H:%M') if item.attendance.marked_at else 'N/A' }}</small>
                            </div>
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="fas fa-times"></i> <strong>Missed</strong><br>
                                <small>Attendance window closed</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- GPS Status Modal -->
<div class="modal fade" id="gpsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-satellite-dish"></i> GPS Check-in
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="gpsStatus" class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        <span>Getting your GPS location...</span>
                    </div>
                </div>
                
                <div id="locationDetails" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h6 id="lectureName" class="card-title"></h6>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Your Distance</small>
                                    <br><strong id="userDistance">-</strong> meters
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Required</small>
                                    <br><strong id="requiredDistance">-</strong> meters
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">GPS Accuracy: <span id="gpsAccuracy">-</span> meters</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmGPSCheckin" disabled>
                    <i class="fas fa-check"></i> Confirm Check-in
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentLecture = null;
let userLocation = null;

function startGPSCheckin(lectureId, title, lectureLat, lectureLon, radius) {
    currentLecture = {
        id: lectureId,
        title: title,
        latitude: lectureLat,
        longitude: lectureLon,
        radius: radius
    };
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('gpsModal'));
    modal.show();
    
    // Update lecture info
    document.getElementById('lectureName').textContent = title;
    document.getElementById('requiredDistance').textContent = radius;
    
    // Reset status
    document.getElementById('gpsStatus').className = 'alert alert-info';
    document.getElementById('gpsStatus').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2"></div>
            <span>Getting your GPS location...</span>
        </div>
    `;
    document.getElementById('locationDetails').style.display = 'none';
    document.getElementById('confirmGPSCheckin').disabled = true;
    
    // Request location permission and get GPS coordinates
    if (navigator.geolocation) {
        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        };
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                // Calculate distance
                const distance = calculateDistance(
                    userLocation.latitude, userLocation.longitude,
                    currentLecture.latitude, currentLecture.longitude
                );
                
                // Update UI
                document.getElementById('userDistance').textContent = Math.round(distance);
                document.getElementById('gpsAccuracy').textContent = Math.round(userLocation.accuracy);
                document.getElementById('locationDetails').style.display = 'block';
                
                if (distance <= currentLecture.radius) {
                    document.getElementById('gpsStatus').className = 'alert alert-success';
                    document.getElementById('gpsStatus').innerHTML = 
                        '<i class="fas fa-check-circle"></i> <strong>Perfect!</strong> You are within the lecture area.';
                    document.getElementById('confirmGPSCheckin').disabled = false;
                } else {
                    document.getElementById('gpsStatus').className = 'alert alert-warning';
                    document.getElementById('gpsStatus').innerHTML = 
                        `<i class="fas fa-exclamation-triangle"></i> <strong>Too far!</strong> You need to be within ${currentLecture.radius}m of the lecture location.`;
                }
            },
            function(error) {
                let errorMessage = 'Unable to get your location.';
                let helpText = '';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Location access denied.';
                        helpText = 'Please enable location services for this website and try again.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Location information unavailable.';
                        helpText = 'Please ensure GPS is enabled and you have a clear view of the sky.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Location request timed out.';
                        helpText = 'Please try again or move to an area with better GPS signal.';
                        break;
                }
                
                document.getElementById('gpsStatus').className = 'alert alert-danger';
                document.getElementById('gpsStatus').innerHTML = 
                    `<i class="fas fa-times-circle"></i> <strong>GPS Error:</strong> ${errorMessage}<br><small>${helpText}</small>`;
            },
            options
        );
    } else {
        document.getElementById('gpsStatus').className = 'alert alert-danger';
        document.getElementById('gpsStatus').innerHTML = 
            '<i class="fas fa-times-circle"></i> <strong>Error:</strong> GPS is not supported by this browser.';
    }
}

document.getElementById('confirmGPSCheckin').addEventListener('click', function() {
    if (!userLocation || !currentLecture) return;
    
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Marking attendance...';
    
    fetch('/student/api/checkin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lecture_id: currentLecture.id,
            latitude: userLocation.latitude,
            longitude: userLocation.longitude
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide GPS modal
            bootstrap.Modal.getInstance(document.getElementById('gpsModal')).hide();
            
            // Show success message
            alert(`✅ ${data.message}\n\n📍 Distance: ${data.distance}m\n⏰ Time: ${data.timestamp || new Date().toLocaleString()}`);
            
            // Refresh page to update status
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert(`❌ Check-in failed: ${data.message}`);
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> Confirm Check-in';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Check-in failed. Please try again.');
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-check"></i> Confirm Check-in';
    });
});

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Earth's radius in meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}
</script>
{% endblock %}