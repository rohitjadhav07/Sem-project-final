{% extends "base.html" %}

{% block title %}Student Dashboard - Geo Attendance Pro{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt"></i> Student Dashboard</h2>
        <p class="text-muted">Welcome back, {{ current_user.full_name }}!</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Enrolled Courses</h5>
                        <h3>{{ enrollments|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Today's Lectures</h5>
                        <h3 id="activeLecturesCount">{{ active_lectures_count }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chalkboard fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Avg Attendance</h5>
                        <h3>{{ "%.1f"|format(attendance_percentage) }}%</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Lectures Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-broadcast-tower"></i> Active Lectures</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshLectures()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>

                    <a href="{{ url_for('student.active_lectures') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> View All
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div id="activeLectures">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading active lectures...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Recent Attendance -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Attendance</h5>
            </div>
            <div class="card-body">
                {% if recent_attendance %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Lecture</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attendance in recent_attendance %}
                                <tr>
                                    <td>{{ attendance.lecture.course.code }}</td>
                                    <td>{{ attendance.lecture.title }}</td>
                                    <td>
                                        {% if attendance.marked_at %}
                                            {{ attendance.marked_at.strftime('%Y-%m-%d %H:%M') }}
                                            {% if attendance.distance_from_lecture %}
                                                <br><small class="text-muted">Distance: {{ "%.1f"|format(attendance.distance_from_lecture) }}m</small>
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if attendance.status == 'present' else 'danger' if attendance.status == 'absent' else 'warning' }}">
                                            {{ attendance.status.title() }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No recent attendance records found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// Simple automatic attendance system
let currentUserLocation = null;
let activeLectures = [];
let checkedInLectures = new Set();

// Start everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Starting simple automatic attendance...');
    
    // Get lectures and start location tracking
    refreshLectures();
    startLocationTracking();
    
    // Update every 5 seconds
    setInterval(() => {
        refreshLectures();
        updateLocationAndDistance();
    }, 5000);
});

function refreshLectures() {
    fetch('/student/api/active-lectures')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            activeLectures = data.lectures || [];
            document.getElementById('activeLecturesCount').textContent = data.count;
            displayLectures(activeLectures);
        }
    })
    .catch(error => {
        console.error('Error loading lectures:', error);
    });
}

function displayLectures(lectures) {
    const container = document.getElementById('activeLectures');
    
    if (lectures.length === 0) {
        container.innerHTML = '<div class="alert alert-info text-center">No active lectures at the moment.</div>';
        return;
    }
    
    let html = '<div class="row">';
    lectures.forEach(lecture => {
        const startTime = new Date(lecture.start_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
        const endTime = new Date(lecture.end_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
        
        // Calculate distance if we have location
        let distanceInfo = '';
        let statusColor = 'secondary';
        let actionButton = '';
        
        if (currentUserLocation && lecture.location) {
            const distance = calculateDistance(
                currentUserLocation.coords.latitude,
                currentUserLocation.coords.longitude,
                lecture.location.latitude,
                lecture.location.longitude
            );
            
            const radius = lecture.location.radius || 50;
            const isWithinRange = distance <= radius;
            
            distanceInfo = `
                <div class="mt-2 p-2 rounded ${isWithinRange ? 'bg-success bg-opacity-10' : 'bg-warning bg-opacity-10'}">
                    <small>
                        <i class="fas fa-map-marker-alt"></i> Distance: <strong>${Math.round(distance)}m</strong> 
                        (Required: ${radius}m)
                        ${isWithinRange ? '<i class="fas fa-check text-success ms-1"></i>' : '<i class="fas fa-times text-warning ms-1"></i>'}
                    </small>
                </div>
            `;
            
            statusColor = isWithinRange ? 'success' : 'warning';
            
            if (isWithinRange && !checkedInLectures.has(lecture.id)) {
                actionButton = `<button class="btn btn-success btn-sm mt-2" onclick="autoCheckIn(${lecture.id})">
                    <i class="fas fa-check"></i> Auto Check-In Available
                </button>`;
            }
        }
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-${statusColor}">
                    <div class="card-body">
                        <h6 class="card-title">${lecture.title}</h6>
                        <p class="card-text text-muted">${lecture.course_code} - ${lecture.course_name}</p>
                        <p class="small text-muted">
                            <i class="fas fa-clock"></i> ${startTime} - ${endTime}
                        </p>
                        ${lecture.location && lecture.location.name ? `<p class="small text-muted"><i class="fas fa-map-marker-alt"></i> ${lecture.location.name}</p>` : ''}
                        ${distanceInfo}
                        ${actionButton}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Simple location tracking
function startLocationTracking() {
    if (!navigator.geolocation) {
        console.log('Geolocation not supported');
        return;
    }
    
    // Get location immediately
    navigator.geolocation.getCurrentPosition(
        (position) => {
            currentUserLocation = position;
            console.log('Location obtained:', Math.round(position.coords.latitude * 10000) / 10000, Math.round(position.coords.longitude * 10000) / 10000);
            updateLocationAndDistance();
        },
        (error) => {
            console.log('Location error, will retry...');
        },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
    );
    
    // Watch location continuously
    navigator.geolocation.watchPosition(
        (position) => {
            currentUserLocation = position;
            updateLocationAndDistance();
        },
        (error) => {
            // Silently handle errors
        },
        { enableHighAccuracy: false, timeout: 5000, maximumAge: 30000 }
    );
}

function updateLocationAndDistance() {
    if (!currentUserLocation || activeLectures.length === 0) return;
    
    // Check each lecture for auto check-in
    activeLectures.forEach(lecture => {
        if (checkedInLectures.has(lecture.id)) return;
        
        const distance = calculateDistance(
            currentUserLocation.coords.latitude,
            currentUserLocation.coords.longitude,
            lecture.location.latitude,
            lecture.location.longitude
        );
        
        const radius = lecture.location.radius || 50;
        
        // Auto check-in if within range
        if (distance <= radius) {
            console.log(`Auto check-in triggered for ${lecture.title} - Distance: ${Math.round(distance)}m`);
            performAutoCheckIn(lecture.id);
        }
    });
    
    // Refresh display to show updated distances
    displayLectures(activeLectures);
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Earth's radius in meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function autoCheckIn(lectureId) {
    performAutoCheckIn(lectureId);
}

function performAutoCheckIn(lectureId) {
    if (!currentUserLocation) return;
    
    checkedInLectures.add(lectureId);
    
    fetch('/student/api/checkin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            lecture_id: lectureId,
            latitude: currentUserLocation.coords.latitude,
            longitude: currentUserLocation.coords.longitude,
            auto_checkin: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`‚úÖ Checked in successfully! Distance: ${Math.round(data.distance)}m`, 'success');
            refreshLectures(); // Refresh to update display
        } else {
            checkedInLectures.delete(lectureId); // Allow retry
            console.error('Check-in failed:', data.message);
        }
    })
    .catch(error => {
        checkedInLectures.delete(lectureId); // Allow retry
        console.error('Check-in error:', error);
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
<script>
// Simple automatic attendance system
let currentUserLocation = null;
let activeLectures = [];
let checkedInLectures = new Set();
let distanceUpdateInterval = null;

// Start everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Starting simple automatic attendance...');
    
    // Get lectures and start location tracking
    refreshLectures();
    startLocationTracking();
    
    // Update every 5 seconds
    setInterval(() => {
        refreshLectures();
        updateLocationAndDistance();
    }, 5000);
});

function refreshLectures() {
    fetch('/student/api/active-lectures')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            activeLectures = data.lectures || [];
            document.getElementById('activeLecturesCount').textContent = data.count;
            displayLectures(activeLectures);
        }
    })
    .catch(error => {
        console.error('Error loading lectures:', error);
    });
}

function displayLectures(lectures) {
    const container = document.getElementById('activeLectures');
    
    if (lectures.length === 0) {
        container.innerHTML = '<div class="alert alert-info text-center">No active lectures at the moment.</div>';
        return;
    }
    
    let html = '<div class="row">';
    lectures.forEach(lecture => {
        const startTime = new Date(lecture.start_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
        const endTime = new Date(lecture.end_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
        
        // Calculate distance if we have location
        let distanceInfo = '';
        let statusColor = 'secondary';
        let actionButton = '';
        
        if (currentUserLocation && lecture.location) {
            const distance = calculateDistance(
                currentUserLocation.coords.latitude,
                currentUserLocation.coords.longitude,
                lecture.location.latitude,
                lecture.location.longitude
            );
            
            const radius = lecture.location.radius || 50;
            const isWithinRange = distance <= radius;
            
            distanceInfo = `
                <div class="mt-2 p-2 rounded ${isWithinRange ? 'bg-success bg-opacity-10' : 'bg-warning bg-opacity-10'}">
                    <small>
                        <i class="fas fa-map-marker-alt"></i> Distance: <strong>${Math.round(distance)}m</strong> 
                        (Required: ${radius}m)
                        ${isWithinRange ? '<i class="fas fa-check text-success ms-1"></i>' : '<i class="fas fa-times text-warning ms-1"></i>'}
                    </small>
                </div>
            `;
            
            statusColor = isWithinRange ? 'success' : 'warning';
            
            if (isWithinRange && !checkedInLectures.has(lecture.id)) {
                actionButton = `<button class="btn btn-success btn-sm mt-2" onclick="autoCheckIn(${lecture.id})">
                    <i class="fas fa-check"></i> Auto Check-In Available
                </button>`;
            }
        }
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-${statusColor}">
                    <div class="card-body">
                        <h6 class="card-title">${lecture.title}</h6>
                        <p class="card-text text-muted">${lecture.course_code} - ${lecture.course_name}</p>
                        <p class="small text-muted">
                            <i class="fas fa-clock"></i> ${startTime} - ${endTime}
                        </p>
                        ${lecture.location && lecture.location.name ? `<p class="small text-muted"><i class="fas fa-map-marker-alt"></i> ${lecture.location.name}</p>` : ''}
                        ${distanceInfo}
                        ${actionButton}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function initiateCheckin(lectureId) {
    // Redirect to active lectures page for check-in
    window.location.href = '/student/active-lectures';
}

function showCheckinModal() {
    const modal = new bootstrap.Modal(document.getElementById('checkinModal'));
    modal.show();
    
    // Update lecture info
    document.getElementById('lectureTitle').textContent = currentLecture.title;
    document.getElementById('courseInfo').textContent = currentLecture.course_name;
    
    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                userLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                
                // Calculate distance
                const distance = calculateDistance(
                    userLocation.latitude, userLocation.longitude,
                    currentLecture.location.latitude, currentLecture.location.longitude
                );
                
                document.getElementById('distance').textContent = Math.round(distance);
                document.getElementById('lectureInfo').style.display = 'block';
                
                if (distance <= currentLecture.location.radius) {
                    document.getElementById('locationStatus').className = 'alert alert-success';
                    document.getElementById('locationStatus').innerHTML = 
                        '<i class="fas fa-check-circle"></i> You are within the lecture area!';
                    document.getElementById('confirmCheckin').disabled = false;
                } else {
                    document.getElementById('locationStatus').className = 'alert alert-warning';
                    document.getElementById('locationStatus').innerHTML = 
                        '<i class="fas fa-exclamation-triangle"></i> You are too far from the lecture location.';
                }
            },
            error => {
                document.getElementById('locationStatus').className = 'alert alert-danger';
                document.getElementById('locationStatus').innerHTML = 
                    '<i class="fas fa-times-circle"></i> Unable to get your location. Please enable location services.';
            }
        );
    } else {
        document.getElementById('locationStatus').className = 'alert alert-danger';
        document.getElementById('locationStatus').innerHTML = 
            '<i class="fas fa-times-circle"></i> Geolocation is not supported by this browser.';
    }
}

document.getElementById('confirmCheckin').addEventListener('click', function() {
    if (!userLocation || !currentLecture) return;
    
    fetch('/student/api/checkin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lecture_id: currentLecture.id,
            latitude: userLocation.latitude,
            longitude: userLocation.longitude
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Check-in successful!');
            bootstrap.Modal.getInstance(document.getElementById('checkinModal')).hide();
            refreshLectures();
        } else {
            alert('Check-in failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Check-in failed. Please try again.');
    });
});

// Simple location tracking
function startLocationTracking() {
    if (!navigator.geolocation) {
        console.log('Geolocation not supported');
        return;
    }
    
    // Get location immediately
    navigator.geolocation.getCurrentPosition(
        (position) => {
            currentUserLocation = position;
            console.log('Location obtained:', Math.round(position.coords.latitude * 10000) / 10000, Math.round(position.coords.longitude * 10000) / 10000);
            updateLocationAndDistance();
        },
        (error) => {
            console.log('Location error, will retry...');
        },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
    );
    
    // Watch location continuously
    navigator.geolocation.watchPosition(
        (position) => {
            currentUserLocation = position;
            updateLocationAndDistance();
        },
        (error) => {
            // Silently handle errors
        },
        { enableHighAccuracy: false, timeout: 5000, maximumAge: 30000 }
    );
}

function updateLocationAndDistance() {
    if (!currentUserLocation || activeLectures.length === 0) return;
    
    // Check each lecture for auto check-in
    activeLectures.forEach(lecture => {
        if (checkedInLectures.has(lecture.id)) return;
        
        const distance = calculateDistance(
            currentUserLocation.coords.latitude,
            currentUserLocation.coords.longitude,
            lecture.location.latitude,
            lecture.location.longitude
        );
        
        const radius = lecture.location.radius || 50;
        
        // Auto check-in if within range
        if (distance <= radius) {
            console.log(`Auto check-in triggered for ${lecture.title} - Distance: ${Math.round(distance)}m`);
            performAutoCheckIn(lecture.id);
        }
    });
    
    // Refresh display to show updated distances
    displayLectures(activeLectures);
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Earth's radius in meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function autoCheckIn(lectureId) {
    performAutoCheckIn(lectureId);
}

function performAutoCheckIn(lectureId) {
    if (!currentUserLocation) return;
    
    checkedInLectures.add(lectureId);
    
    fetch('/student/api/checkin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            lecture_id: lectureId,
            latitude: currentUserLocation.coords.latitude,
            longitude: currentUserLocation.coords.longitude,
            auto_checkin: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`‚úÖ Checked in successfully! Distance: ${Math.round(data.distance)}m`, 'success');
            refreshLectures(); // Refresh to update display
        } else {
            checkedInLectures.delete(lectureId); // Allow retry
            console.error('Check-in failed:', data.message);
        }
    })
    .catch(error => {
        checkedInLectures.delete(lectureId); // Allow retry
        console.error('Check-in error:', error);
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Auto check-in functionality
let autoCheckInInterval = null;
let currentUserLocation = null;
let checkedInLectures = new Set();

async function startAutoCheckIn() {
    console.log('üöÄ Starting automatic check-in system...');
    
    // Check permission status first
    await checkLocationPermission();
    
    // Check every 30 seconds for auto check-in opportunities
    autoCheckInInterval = setInterval(() => {
        if (currentUserLocation) {
            checkForAutoCheckIn();
        } else {
            // Try to get location again if we don't have it
            requestLocationPermission();
        }
    }, 30000);
    
    // Also check immediately after getting location
    setTimeout(() => {
        if (currentUserLocation) {
            checkForAutoCheckIn();
        }
    }, 5000);
}

async function checkLocationPermission() {
    console.log('üîç Checking location permission status...');
    
    // Check if permissions API is available
    if ('permissions' in navigator) {
        try {
            const permission = await navigator.permissions.query({name: 'geolocation'});
            console.log('üìã Permission status:', permission.state);
            
            switch (permission.state) {
                case 'granted':
                    showLocationStatus('Location permission granted! Getting your location...', 'success');
                    requestLocationPermission();
                    break;
                case 'denied':
                    showLocationStatus('Location access denied. Please enable location access. <button class="btn btn-sm btn-outline-primary ms-2" onclick="showLocationHelp()">Enable Location</button>', 'error');
                    break;
                case 'prompt':
                    showLocationStatus('Location permission required. Click allow when prompted.', 'info');
                    requestLocationPermission();
                    break;
            }
            
            // Listen for permission changes
            permission.addEventListener('change', () => {
                console.log('üìã Permission changed to:', permission.state);
                if (permission.state === 'granted') {
                    requestLocationPermission();
                }
            });
            
        } catch (error) {
            console.log('‚ö†Ô∏è Permissions API not supported, trying direct location request');
            requestLocationPermission();
        }
    } else {
        console.log('‚ö†Ô∏è Permissions API not available, trying direct location request');
        requestLocationPermission();
    }
}

function requestLocationPermission() {
    console.log('üìç Requesting location permission...');
    
    if (!navigator.geolocation) {
        console.error('‚ùå Geolocation not supported');
        showLocationStatus('Geolocation not supported by your browser', 'error');
        return;
    }
    
    // Show loading status
    showLocationStatus('Requesting location permission...', 'info');
    
    // Try with more permissive options first
    const options = {
        enableHighAccuracy: false,  // Start with less strict requirements
        timeout: 30000,             // Longer timeout
        maximumAge: 300000          // 5 minutes cache
    };
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            currentUserLocation = position;
            console.log('‚úÖ Location obtained:', position.coords);
            showLocationStatus(`Location enabled! Accuracy: ¬±${Math.round(position.coords.accuracy)}m`, 'success');
            
            // Now try to get high accuracy location
            getHighAccuracyLocation();
            
            // Start watching location for continuous updates
            startLocationWatching();
            
            // Check for immediate auto check-in
            setTimeout(() => checkForAutoCheckIn(), 2000);
        },
        (error) => {
            console.error('‚ùå Location error:', error);
            
            // If first attempt fails, try with different options
            if (error.code === error.TIMEOUT) {
                console.log('‚ö†Ô∏è Timeout, trying with lower accuracy...');
                tryFallbackLocation();
            } else {
                handleLocationError(error);
            }
        },
        options
    );
}

function getHighAccuracyLocation() {
    // Try to get more accurate location after initial success
    navigator.geolocation.getCurrentPosition(
        (position) => {
            if (position.coords.accuracy < currentUserLocation.coords.accuracy) {
                currentUserLocation = position;
                console.log('‚úÖ High accuracy location obtained:', position.coords);
                showLocationStatus(`High accuracy location! Accuracy: ¬±${Math.round(position.coords.accuracy)}m`, 'success');
            }
        },
        (error) => {
            console.log('‚ö†Ô∏è High accuracy location failed, using standard location');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

function tryFallbackLocation() {
    console.log('üîÑ Trying fallback location options...');
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            currentUserLocation = position;
            console.log('‚úÖ Fallback location obtained:', position.coords);
            showLocationStatus(`Location enabled (fallback)! Accuracy: ¬±${Math.round(position.coords.accuracy)}m`, 'success');
            
            startLocationWatching();
            setTimeout(() => checkForAutoCheckIn(), 2000);
        },
        (error) => {
            console.error('‚ùå Fallback location also failed:', error);
            handleLocationError(error);
        },
        {
            enableHighAccuracy: false,
            timeout: 60000,
            maximumAge: 600000  // 10 minutes cache
        }
    );
}

function startLocationWatching() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                currentUserLocation = position;
                console.log('üìç Location updated:', position.coords);
            },
            (error) => {
                console.warn('‚ö†Ô∏è Location watch error:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000
            }
        );
    }
}

function handleLocationError(error) {
    let message = 'Unable to get your location. ';
    let isRetryable = false;
    
    switch (error.code) {
        case error.PERMISSION_DENIED:
            message = 'üö´ Location access denied. Please enable location access in your browser settings.';
            showLocationStatus(message + ' <button class="btn btn-sm btn-outline-primary ms-2" onclick="showLocationHelp()">How to Enable</button>', 'error');
            
            // Also try to detect if it's a temporary denial
            setTimeout(() => {
                showLocationStatus('üí° Tip: Look for a location icon (üîí or üìç) in your browser address bar and click "Allow"', 'info');
            }, 3000);
            break;
            
        case error.POSITION_UNAVAILABLE:
            message = 'üì° Your location is currently unavailable. Please check your device settings.';
            isRetryable = true;
            break;
            
        case error.TIMEOUT:
            message = '‚è±Ô∏è Location request timed out. This might be due to poor GPS signal.';
            isRetryable = true;
            break;
            
        default:
            message = '‚ùå Unknown location error occurred.';
            isRetryable = true;
    }
    
    if (isRetryable) {
        showLocationStatus(message + ' <button class="btn btn-sm btn-outline-primary ms-2" onclick="requestLocationPermission()">Try Again</button>', 'error');
        
        // Auto-retry after 10 seconds for timeout/unavailable errors
        setTimeout(() => {
            console.log('üîÑ Auto-retrying location request...');
            requestLocationPermission();
        }, 10000);
    } else {
        showLocationStatus(message, 'error');
    }
    
    // Show additional help based on user agent
    setTimeout(() => {
        const userAgent = navigator.userAgent.toLowerCase();
        let helpText = '';
        
        if (userAgent.includes('chrome')) {
            helpText = 'üí° Chrome: Click the üîí icon in address bar ‚Üí Location ‚Üí Allow';
        } else if (userAgent.includes('firefox')) {
            helpText = 'üí° Firefox: Click the üõ°Ô∏è icon in address bar ‚Üí Allow Location Access';
        } else if (userAgent.includes('safari')) {
            helpText = 'üí° Safari: Safari menu ‚Üí Preferences ‚Üí Websites ‚Üí Location Services';
        } else if (userAgent.includes('mobile')) {
            helpText = 'üí° Mobile: Check browser settings ‚Üí Site permissions ‚Üí Location';
        }
        
        if (helpText) {
            console.log(helpText);
        }
    }, 2000);
}

function showLocationHelp() {
    const modal = new bootstrap.Modal(document.getElementById('locationPermissionModal'));
    modal.show();
}

function testLocationAccess() {
    console.log('üß™ Testing location access...');
    showLocationStatus('Testing location access...', 'info');
    
    if (!navigator.geolocation) {
        showLocationStatus('‚ùå Geolocation not supported by your browser', 'error');
        return;
    }
    
    // Test with very permissive settings
    navigator.geolocation.getCurrentPosition(
        (position) => {
            console.log('‚úÖ Location test successful:', position.coords);
            showLocationStatus(`‚úÖ Location test successful! Lat: ${position.coords.latitude.toFixed(4)}, Lon: ${position.coords.longitude.toFixed(4)}, Accuracy: ¬±${Math.round(position.coords.accuracy)}m`, 'success');
            
            // Update current location if we don't have one
            if (!currentUserLocation) {
                currentUserLocation = position;
                startLocationWatching();
            }
        },
        (error) => {
            console.error('‚ùå Location test failed:', error);
            let errorMsg = 'Location test failed: ';
            
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg += 'Permission denied. Please allow location access.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg += 'Position unavailable. Check your GPS settings.';
                    break;
                case error.TIMEOUT:
                    errorMsg += 'Request timed out. Try moving to a better location.';
                    break;
                default:
                    errorMsg += 'Unknown error occurred.';
            }
            
            showLocationStatus(errorMsg + ' <button class="btn btn-sm btn-outline-primary ms-2" onclick="showLocationHelp()">Get Help</button>', 'error');
        },
        {
            enableHighAccuracy: false,
            timeout: 15000,
            maximumAge: 60000
        }
    );
}

function showLocationStatus(message, type) {
    // Create or update status indicator
    let statusDiv = document.getElementById('locationStatus');
    if (!statusDiv) {
        statusDiv = document.createElement('div');
        statusDiv.id = 'locationStatus';
        statusDiv.className = 'alert alert-sm mb-2';
        
        // Insert at top of page
        const container = document.querySelector('.container-fluid');
        if (container) {
            container.insertBefore(statusDiv, container.firstChild);
        }
    }
    
    // Update status
    statusDiv.className = `alert alert-sm mb-2 alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}`;
    statusDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
    `;
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }, 5000);
    }
}

function checkForAutoCheckIn() {
    if (!currentUserLocation) {
        console.log('‚ö†Ô∏è No location available for auto check-in');
        return;
    }
    
    console.log('üîç Checking for auto check-in opportunities...');
    
    // Get current active lectures
    fetch('/student/api/active-lectures')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.lectures) {
            data.lectures.forEach(lecture => {
                // Skip if already checked in to this lecture
                if (checkedInLectures.has(lecture.id)) {
                    return;
                }
                
                // Check if within geofence
                const distance = calculateDistance(
                    currentUserLocation.coords.latitude,
                    currentUserLocation.coords.longitude,
                    lecture.location.latitude,
                    lecture.location.longitude
                );
                
                console.log(`üìè Distance to ${lecture.title}: ${Math.round(distance)}m (required: ${lecture.location.radius}m)`);
                
                if (distance <= lecture.location.radius) {
                    console.log(`‚úÖ Auto check-in possible for: ${lecture.title}`);
                    performAutoCheckIn(lecture, distance);
                }
            });
        }
    })
    .catch(error => {
        console.error('‚ùå Error checking for auto check-in:', error);
    });
}

function performAutoCheckIn(lecture, distance) {
    console.log(`üéØ Performing auto check-in for: ${lecture.title}`);
    
    // Mark as checked in to prevent duplicates
    checkedInLectures.add(lecture.id);
    
    // Show notification
    showAutoCheckInNotification(lecture, distance);
    
    // Perform the check-in
    fetch('/student/api/checkin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lecture_id: lecture.id,
            latitude: currentUserLocation.coords.latitude,
            longitude: currentUserLocation.coords.longitude,
            auto_checkin: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`‚úÖ Auto check-in successful for: ${lecture.title}`);
            showLocationStatus(`‚úÖ Automatically checked in to ${lecture.title}! Distance: ${Math.round(distance)}m`, 'success');
            
            // Refresh lectures to update UI
            setTimeout(() => refreshLectures(), 1000);
        } else {
            console.error(`‚ùå Auto check-in failed for ${lecture.title}:`, data.message);
            checkedInLectures.delete(lecture.id); // Allow retry
        }
    })
    .catch(error => {
        console.error(`‚ùå Auto check-in error for ${lecture.title}:`, error);
        checkedInLectures.delete(lecture.id); // Allow retry
    });
}

function showAutoCheckInNotification(lecture, distance) {
    // Create notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show';
    notification.innerHTML = `
        <strong>üéØ Auto Check-in!</strong><br>
        <strong>${lecture.title}</strong><br>
        <small>Distance: ${Math.round(distance)}m ‚Ä¢ ${lecture.course_code}</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(notification, container.firstChild);
    }
    
    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 8000);
}
</script>
{% endblock %}