{% extends "base.html" %}

{% block title %}Student Dashboard - Geo Attendance Pro{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt"></i> Student Dashboard</h2>
        <p class="text-muted">Welcome back, {{ current_user.full_name }}!</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Enrolled Courses</h5>
                        <h3>{{ enrollments|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Today's Lectures</h5>
                        <h3 id="activeLecturesCount">{{ active_lectures_count }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chalkboard fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Avg Attendance</h5>
                        <h3>{{ "%.1f"|format(attendance_percentage) }}%</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Lectures Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-broadcast-tower"></i> Active Lectures</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshLectures()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <a href="{{ url_for('student.active_lectures') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> View All
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div id="activeLectures">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading active lectures...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Attendance -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Attendance</h5>
            </div>
            <div class="card-body">
                {% if recent_attendance %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Lecture</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attendance in recent_attendance %}
                            <tr>
                                <td>{{ attendance.lecture.course.code }}</td>
                                <td>{{ attendance.lecture.title }}</td>
                                <td>
                                    {% if attendance.marked_at %}
                                    {{ attendance.marked_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% if attendance.distance_from_lecture %}
                                    <br><small class="text-muted">Distance: {{
                                        "%.1f"|format(attendance.distance_from_lecture) }}m</small>
                                    {% endif %}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <span
                                        class="badge bg-{{ 'success' if attendance.status == 'present' else 'danger' if attendance.status == 'absent' else 'warning' }}">
                                        {{ attendance.status.title() }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No recent attendance records found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/enhanced_gps.js') }}"></script>
<script>
    // Enhanced automatic attendance system with improved GPS accuracy
    let currentUserLocation = null;
    let activeLectures = [];
    let checkedInLectures = new Set();
    let enhancedGPS = null;
    let gpsKalmanFilter = null;

    // Start everything when page loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ðŸš€ Starting enhanced automatic attendance with improved GPS...');

        // Initialize Kalman filter for smoothing
        gpsKalmanFilter = new GPSKalmanFilter(0.001, 10);

        // Get lectures
        refreshLectures();
        
        // Start enhanced GPS tracking
        startEnhancedLocationTracking();

        // Update every 5 seconds
        setInterval(() => {
            refreshLectures();
            updateLocationAndDistance();
        }, 5000);
    });

    function refreshLectures() {
        fetch('/student/api/active-lectures')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    activeLectures = data.lectures || [];
                    document.getElementById('activeLecturesCount').textContent = data.count;
                    displayLectures(activeLectures);
                }
            })
            .catch(error => {
                console.error('Error loading lectures:', error);
            });
    }

    function displayLectures(lectures) {
        const container = document.getElementById('activeLectures');

        if (lectures.length === 0) {
            container.innerHTML = '<div class="alert alert-info text-center">No active lectures at the moment.</div>';
            return;
        }

        let html = '<div class="row">';
        lectures.forEach(lecture => {
            const startTime = new Date(lecture.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
            const endTime = new Date(lecture.end_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

            // Calculate distance if we have location
            let distanceInfo = '';
            let statusColor = 'secondary';
            let actionButton = '';

            if (currentUserLocation && lecture.location) {
                const distance = calculateDistance(
                    currentUserLocation.coords.latitude,
                    currentUserLocation.coords.longitude,
                    lecture.location.latitude,
                    lecture.location.longitude
                );

                // Check if lecture uses rectangular boundary
                const geofenceType = lecture.geofence_type || 'circular';
                let isWithinRange = false;
                let boundaryInfo = '';

                if (geofenceType === 'rectangular' && lecture.boundary) {
                    // Use rectangular boundary validation
                    isWithinRange = isPointInRectangle(
                        currentUserLocation.coords.latitude,
                        currentUserLocation.coords.longitude,
                        lecture.boundary
                    );
                    const area = lecture.boundary_area_sqm || 0;
                    boundaryInfo = `Rectangular (${Math.round(Math.sqrt(area))}m Ã— ${Math.round(Math.sqrt(area))}m)`;
                } else {
                    // Use circular validation (fallback)
                    const radius = lecture.location.radius || 50;
                    isWithinRange = distance <= radius;
                    boundaryInfo = `Circular (${radius}m radius)`;
                }

                distanceInfo = `
                <div class="mt-2 p-2 rounded ${isWithinRange ? 'bg-success bg-opacity-10' : 'bg-warning bg-opacity-10'}">
                    <small>
                        <i class="fas fa-map-marker-alt"></i> Distance: <strong>${Math.round(distance)}m</strong><br>
                        <i class="fas fa-border-all"></i> Boundary: ${boundaryInfo}
                        ${isWithinRange ? '<i class="fas fa-check text-success ms-1"></i>' : '<i class="fas fa-times text-warning ms-1"></i>'}
                    </small>
                </div>
            `;

                statusColor = isWithinRange ? 'success' : 'warning';

                if (isWithinRange && !checkedInLectures.has(lecture.id)) {
                    actionButton = `<button class="btn btn-success btn-sm mt-2" onclick="autoCheckIn(${lecture.id})">
                    <i class="fas fa-check"></i> Auto Check-In Available
                </button>`;
                }
            }

            html += `
            <div class="col-md-6 mb-3">
                <div class="card border-${statusColor}">
                    <div class="card-body">
                        <h6 class="card-title">${lecture.title}</h6>
                        <p class="card-text text-muted">${lecture.course_code} - ${lecture.course_name}</p>
                        <p class="small text-muted">
                            <i class="fas fa-clock"></i> ${startTime} - ${endTime}
                        </p>
                        ${lecture.location && lecture.location.name ? `<p class="small text-muted"><i class="fas fa-map-marker-alt"></i> ${lecture.location.name}</p>` : ''}
                        ${distanceInfo}
                        ${actionButton}
                    </div>
                </div>
            </div>
        `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // Enhanced location tracking with multiple readings and averaging
    function startEnhancedLocationTracking() {
        if (!navigator.geolocation) {
            console.log('Geolocation not supported');
            showNotification('âš ï¸ GPS not supported on this device', 'warning');
            return;
        }

        // Initialize enhanced GPS with optimal settings
        enhancedGPS = new EnhancedGPS({
            warmupReadings: 5,           // Collect 5 readings during warm-up
            warmupTimeout: 30000,        // 30 second warm-up timeout
            minAccuracy: 20,             // Minimum acceptable accuracy (20m)
            enableHighAccuracy: true,    // Use high accuracy mode
            averageReadings: 3,          // Average last 3 readings
            maxAge: 5000                 // Max age of cached position (5 seconds)
        });

        // Set warm-up complete callback
        enhancedGPS.callbacks.onWarmupComplete = (position) => {
            console.log('âœ… GPS warm-up complete! Accuracy: Â±' + Math.round(position.coords.accuracy) + 'm');
            showNotification('ðŸ“ GPS ready with Â±' + Math.round(position.coords.accuracy) + 'm accuracy', 'success');
        };

        // Start tracking
        enhancedGPS.start(
            (position) => {
                // Apply Kalman filtering for additional smoothing
                const filtered = gpsKalmanFilter.filter(
                    position.coords.latitude,
                    position.coords.longitude,
                    position.coords.accuracy
                );

                // Update position with filtered coordinates
                currentUserLocation = {
                    coords: {
                        ...position.coords,
                        latitude: filtered.latitude,
                        longitude: filtered.longitude
                    },
                    timestamp: position.timestamp,
                    averaged: position.averaged,
                    filtered: true
                };

                // Log accuracy improvements
                if (position.averaged) {
                    console.log('ðŸ“ Enhanced GPS update: Â±' + Math.round(position.coords.accuracy) + 'm ' +
                              '(averaged from ' + position.readingCount + ' readings, Kalman filtered)');
                }

                updateLocationAndDistance();
            },
            (error) => {
                console.error('GPS error:', error);
                showNotification('âš ï¸ GPS error: ' + error.message, 'warning');
            }
        );

        // Show GPS status every 30 seconds
        setInterval(() => {
            if (enhancedGPS) {
                const status = enhancedGPS.getStatus();
                console.log('ðŸ“Š GPS Status:', status);
            }
        }, 30000);
    }

    function updateLocationAndDistance() {
        if (!currentUserLocation || activeLectures.length === 0) return;

        // Check each lecture for auto check-in
        activeLectures.forEach(lecture => {
            if (checkedInLectures.has(lecture.id)) return;

            const geofenceType = lecture.geofence_type || 'circular';
            let isWithinRange = false;

            if (geofenceType === 'rectangular' && lecture.boundary) {
                // Use rectangular boundary validation
                isWithinRange = isPointInRectangle(
                    currentUserLocation.coords.latitude,
                    currentUserLocation.coords.longitude,
                    lecture.boundary
                );
            } else {
                // Use circular validation (fallback)
                const distance = calculateDistance(
                    currentUserLocation.coords.latitude,
                    currentUserLocation.coords.longitude,
                    lecture.location.latitude,
                    lecture.location.longitude
                );
                const radius = lecture.location.radius || 50;
                isWithinRange = distance <= radius;
            }

            // Auto check-in if within range
            if (isWithinRange) {
                console.log(`Auto check-in triggered for ${lecture.title} - Within ${geofenceType} boundary`);
                performAutoCheckIn(lecture.id);
            }
        });

        // Refresh display to show updated distances
        displayLectures(activeLectures);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Earth's radius in meters
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function isPointInRectangle(lat, lon, boundary) {
        // Ray casting algorithm for point-in-polygon
        // boundary has corners: {ne: [lat, lon], nw: [...], se: [...], sw: [...]}
        if (!boundary || !boundary.corners) return false;

        const corners = boundary.corners;
        const polygon = [
            corners.nw,
            corners.ne,
            corners.se,
            corners.sw
        ];

        let inside = false;
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
            const xi = polygon[i][1], yi = polygon[i][0];
            const xj = polygon[j][1], yj = polygon[j][0];

            const intersect = ((yi > lat) !== (yj > lat))
                && (lon < (xj - xi) * (lat - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }

        return inside;
    }

    function autoCheckIn(lectureId) {
        performAutoCheckIn(lectureId);
    }

    function performAutoCheckIn(lectureId) {
        if (!currentUserLocation) return;

        checkedInLectures.add(lectureId);

        fetch('/student/api/checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                lecture_id: lectureId,
                latitude: currentUserLocation.coords.latitude,
                longitude: currentUserLocation.coords.longitude,
                auto_checkin: true
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`âœ… Checked in successfully! Distance: ${Math.round(data.distance)}m`, 'success');
                    refreshLectures(); // Refresh to update display
                } else {
                    checkedInLectures.delete(lectureId); // Allow retry
                    console.error('Check-in failed:', data.message);
                }
            })
            .catch(error => {
                checkedInLectures.delete(lectureId); // Allow retry
                console.error('Check-in error:', error);
            });
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}