{% extends "base.html" %}

{% block title %}Student Dashboard - Geo Attendance Pro{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt"></i> Student Dashboard</h2>
        <p class="text-muted">Welcome back, {{ current_user.full_name }}!</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Enrolled Courses</h5>
                        <h3>{{ enrollments|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Today's Lectures</h5>
                        <h3 id="activeLecturesCount">{{ active_lectures_count }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chalkboard fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Avg Attendance</h5>
                        <h3>{{ "%.1f"|format(attendance_percentage) }}%</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Lectures Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-broadcast-tower"></i> Active Lectures</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshLectures()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <a href="{{ url_for('student.active_lectures') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> View All
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div id="activeLectures">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading active lectures...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Recent Attendance -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Attendance</h5>
            </div>
            <div class="card-body">
                {% if recent_attendance %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Lecture</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attendance in recent_attendance %}
                                <tr>
                                    <td>{{ attendance.lecture.course.code }}</td>
                                    <td>{{ attendance.lecture.title }}</td>
                                    <td>
                                        {% if attendance.marked_at %}
                                            {{ attendance.marked_at.strftime('%Y-%m-%d %H:%M') }}
                                            {% if attendance.distance_from_lecture %}
                                                <br><small class="text-muted">Distance: {{ "%.1f"|format(attendance.distance_from_lecture) }}m</small>
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if attendance.status == 'present' else 'danger' if attendance.status == 'absent' else 'warning' }}">
                                            {{ attendance.status.title() }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No recent attendance records found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Location Permission Help Modal -->
<div class="modal fade" id="locationPermissionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìç Enable Location Access</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>üéØ Automatic attendance requires location access</strong><br>
                    We'll automatically mark your attendance when you're near a lecture location.
                </div>
                
                <h6>How to enable location access:</h6>
                
                <div class="accordion" id="locationHelp">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#chrome-help">
                                Chrome / Edge
                            </button>
                        </h2>
                        <div id="chrome-help" class="accordion-collapse collapse show" data-bs-parent="#locationHelp">
                            <div class="accordion-body">
                                <ol>
                                    <li>Click the <strong>üîí lock icon</strong> in the address bar</li>
                                    <li>Set <strong>"Location"</strong> to <strong>"Allow"</strong></li>
                                    <li>Refresh the page</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#firefox-help">
                                Firefox
                            </button>
                        </h2>
                        <div id="firefox-help" class="accordion-collapse collapse" data-bs-parent="#locationHelp">
                            <div class="accordion-body">
                                <ol>
                                    <li>Click the <strong>üõ°Ô∏è shield icon</strong> in the address bar</li>
                                    <li>Click <strong>"Allow Location Access"</strong></li>
                                    <li>Refresh the page</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-help">
                                Mobile Browsers
                            </button>
                        </h2>
                        <div id="mobile-help" class="accordion-collapse collapse" data-bs-parent="#locationHelp">
                            <div class="accordion-body">
                                <ol>
                                    <li>Go to your browser settings</li>
                                    <li>Find <strong>"Site permissions"</strong> or <strong>"Location"</strong></li>
                                    <li>Allow location for this website</li>
                                    <li>Refresh the page</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <strong>Still not working?</strong><br>
                    ‚Ä¢ Make sure you're not in incognito/private mode<br>
                    ‚Ä¢ Try refreshing the page<br>
                    ‚Ä¢ Move to an area with better GPS signal
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="requestLocationPermission()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentLecture = null;
let userLocation = null;

// Load active lectures on page load and start auto check-in
document.addEventListener('DOMContentLoaded', function() {
    refreshLectures();
    startAutoCheckIn();
});

function refreshLectures() {
    console.log('Fetching active lectures...');
    
    fetch('/student/api/active-lectures')
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('API Response:', data);
        
        if (data.success) {
            document.getElementById('activeLecturesCount').textContent = data.count;
            displayLectures(data.lectures || []);
            
            // Show debug info in console
            if (data.debug) {
                console.log('Debug info:', data.debug);
            }
        } else {
            console.error('API returned error:', data.error);
            const container = document.getElementById('activeLectures');
            container.innerHTML = `<div class="alert alert-danger">Error loading lectures: ${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        const container = document.getElementById('activeLectures');
        container.innerHTML = `<div class="alert alert-danger">Failed to load lectures. Please try again.</div>`;
    });
}

function displayLectures(lectures) {
    const container = document.getElementById('activeLectures');
    
    if (lectures.length === 0) {
        container.innerHTML = '<div class="alert alert-info text-center"><i class="fas fa-info-circle"></i> No active lectures available for check-in at the moment.</div>';
        return;
    }
    
    let html = '<div class="row">';
    lectures.forEach(lecture => {
        // Parse timezone-aware times properly
        const startTime = new Date(lecture.start_time).toLocaleTimeString([], {
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true
        });
        const endTime = new Date(lecture.end_time).toLocaleTimeString([], {
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true
        });
        
        // Check if lecture is currently active
        const now = new Date();
        const lectureStart = new Date(lecture.start_time);
        const lectureEnd = new Date(lecture.end_time);
        const isActive = now >= lectureStart && now <= lectureEnd;
        const isUpcoming = now < lectureStart;
        
        const statusBadge = isActive ? 
            '<span class="badge bg-success ms-2">Live Now</span>' : 
            isUpcoming ? '<span class="badge bg-warning ms-2">Upcoming</span>' : 
            '<span class="badge bg-secondary ms-2">Ended</span>';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card ${isActive ? 'border-success' : isUpcoming ? 'border-warning' : 'border-secondary'}">
                    <div class="card-body">
                        <h6 class="card-title">
                            ${lecture.title}
                            ${statusBadge}
                        </h6>
                        <p class="card-text text-muted">${lecture.course_code} - ${lecture.course_name}</p>
                        <p class="small text-muted">
                            <i class="fas fa-clock"></i> ${startTime} - ${endTime}
                        </p>
                        ${lecture.location && lecture.location.name ? `<p class="small text-muted"><i class="fas fa-map-marker-alt"></i> ${lecture.location.name}</p>` : ''}
                        <div class="d-grid gap-2">
                            ${isActive ? 
                                `<a href="/student/lecture/${lecture.id}/enhanced-checkin" class="btn btn-success btn-sm">
                                    <i class="fas fa-shield-alt"></i> Check In Now
                                </a>` :
                                `<button class="btn btn-outline-secondary btn-sm" disabled>
                                    <i class="fas fa-clock"></i> ${isUpcoming ? 'Not Started' : 'Ended'}
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function initiateCheckin(lectureId) {
    // Redirect to active lectures page for check-in
    window.location.href = '/student/active-lectures';
}

function showCheckinModal() {
    const modal = new bootstrap.Modal(document.getElementById('checkinModal'));
    modal.show();
    
    // Update lecture info
    document.getElementById('lectureTitle').textContent = currentLecture.title;
    document.getElementById('courseInfo').textContent = currentLecture.course_name;
    
    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                userLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                
                // Calculate distance
                const distance = calculateDistance(
                    userLocation.latitude, userLocation.longitude,
                    currentLecture.location.latitude, currentLecture.location.longitude
                );
                
                document.getElementById('distance').textContent = Math.round(distance);
                document.getElementById('lectureInfo').style.display = 'block';
                
                if (distance <= currentLecture.location.radius) {
                    document.getElementById('locationStatus').className = 'alert alert-success';
                    document.getElementById('locationStatus').innerHTML = 
                        '<i class="fas fa-check-circle"></i> You are within the lecture area!';
                    document.getElementById('confirmCheckin').disabled = false;
                } else {
                    document.getElementById('locationStatus').className = 'alert alert-warning';
                    document.getElementById('locationStatus').innerHTML = 
                        '<i class="fas fa-exclamation-triangle"></i> You are too far from the lecture location.';
                }
            },
            error => {
                document.getElementById('locationStatus').className = 'alert alert-danger';
                document.getElementById('locationStatus').innerHTML = 
                    '<i class="fas fa-times-circle"></i> Unable to get your location. Please enable location services.';
            }
        );
    } else {
        document.getElementById('locationStatus').className = 'alert alert-danger';
        document.getElementById('locationStatus').innerHTML = 
            '<i class="fas fa-times-circle"></i> Geolocation is not supported by this browser.';
    }
}

document.getElementById('confirmCheckin').addEventListener('click', function() {
    if (!userLocation || !currentLecture) return;
    
    fetch('/student/api/checkin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lecture_id: currentLecture.id,
            latitude: userLocation.latitude,
            longitude: userLocation.longitude
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Check-in successful!');
            bootstrap.Modal.getInstance(document.getElementById('checkinModal')).hide();
            refreshLectures();
        } else {
            alert('Check-in failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Check-in failed. Please try again.');
    });
});

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Earth's radius in meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Auto check-in functionality
let autoCheckInInterval = null;
let currentUserLocation = null;
let checkedInLectures = new Set();

function startAutoCheckIn() {
    console.log('üöÄ Starting automatic check-in system...');
    
    // Request location permission immediately
    requestLocationPermission();
    
    // Check every 30 seconds for auto check-in opportunities
    autoCheckInInterval = setInterval(() => {
        if (currentUserLocation) {
            checkForAutoCheckIn();
        }
    }, 30000);
    
    // Also check immediately after getting location
    setTimeout(() => {
        if (currentUserLocation) {
            checkForAutoCheckIn();
        }
    }, 5000);
}

function requestLocationPermission() {
    console.log('üìç Requesting location permission...');
    
    if (!navigator.geolocation) {
        console.error('‚ùå Geolocation not supported');
        showLocationStatus('Geolocation not supported by your browser', 'error');
        return;
    }
    
    // Show loading status
    showLocationStatus('Requesting location permission...', 'info');
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            currentUserLocation = position;
            console.log('‚úÖ Location obtained:', position.coords);
            showLocationStatus(`Location enabled! Accuracy: ¬±${Math.round(position.coords.accuracy)}m`, 'success');
            
            // Start watching location for continuous updates
            startLocationWatching();
            
            // Check for immediate auto check-in
            setTimeout(() => checkForAutoCheckIn(), 2000);
        },
        (error) => {
            console.error('‚ùå Location error:', error);
            handleLocationError(error);
        },
        {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 60000
        }
    );
}

function startLocationWatching() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                currentUserLocation = position;
                console.log('üìç Location updated:', position.coords);
            },
            (error) => {
                console.warn('‚ö†Ô∏è Location watch error:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000
            }
        );
    }
}

function handleLocationError(error) {
    let message = 'Unable to get your location. ';
    
    switch (error.code) {
        case error.PERMISSION_DENIED:
            message = 'Location access denied. Click "Enable Location" for automatic attendance.';
            showLocationStatus(message + ' <button class="btn btn-sm btn-outline-primary ms-2" onclick="showLocationHelp()">Enable Location</button>', 'error');
            break;
        case error.POSITION_UNAVAILABLE:
            message = 'Your location is currently unavailable. Please ensure GPS is enabled.';
            showLocationStatus(message, 'error');
            break;
        case error.TIMEOUT:
            message = 'Location request timed out. Please try again.';
            showLocationStatus(message + ' <button class="btn btn-sm btn-outline-primary ms-2" onclick="requestLocationPermission()">Try Again</button>', 'error');
            break;
        default:
            showLocationStatus(message, 'error');
    }
}

function showLocationHelp() {
    const modal = new bootstrap.Modal(document.getElementById('locationPermissionModal'));
    modal.show();
}

function showLocationStatus(message, type) {
    // Create or update status indicator
    let statusDiv = document.getElementById('locationStatus');
    if (!statusDiv) {
        statusDiv = document.createElement('div');
        statusDiv.id = 'locationStatus';
        statusDiv.className = 'alert alert-sm mb-2';
        
        // Insert at top of page
        const container = document.querySelector('.container-fluid');
        if (container) {
            container.insertBefore(statusDiv, container.firstChild);
        }
    }
    
    // Update status
    statusDiv.className = `alert alert-sm mb-2 alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}`;
    statusDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
    `;
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }, 5000);
    }
}

function checkForAutoCheckIn() {
    if (!currentUserLocation) {
        console.log('‚ö†Ô∏è No location available for auto check-in');
        return;
    }
    
    console.log('üîç Checking for auto check-in opportunities...');
    
    // Get current active lectures
    fetch('/student/api/active-lectures')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.lectures) {
            data.lectures.forEach(lecture => {
                // Skip if already checked in to this lecture
                if (checkedInLectures.has(lecture.id)) {
                    return;
                }
                
                // Check if within geofence
                const distance = calculateDistance(
                    currentUserLocation.coords.latitude,
                    currentUserLocation.coords.longitude,
                    lecture.location.latitude,
                    lecture.location.longitude
                );
                
                console.log(`üìè Distance to ${lecture.title}: ${Math.round(distance)}m (required: ${lecture.location.radius}m)`);
                
                if (distance <= lecture.location.radius) {
                    console.log(`‚úÖ Auto check-in possible for: ${lecture.title}`);
                    performAutoCheckIn(lecture, distance);
                }
            });
        }
    })
    .catch(error => {
        console.error('‚ùå Error checking for auto check-in:', error);
    });
}

function performAutoCheckIn(lecture, distance) {
    console.log(`üéØ Performing auto check-in for: ${lecture.title}`);
    
    // Mark as checked in to prevent duplicates
    checkedInLectures.add(lecture.id);
    
    // Show notification
    showAutoCheckInNotification(lecture, distance);
    
    // Perform the check-in
    fetch('/student/api/checkin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lecture_id: lecture.id,
            latitude: currentUserLocation.coords.latitude,
            longitude: currentUserLocation.coords.longitude,
            auto_checkin: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`‚úÖ Auto check-in successful for: ${lecture.title}`);
            showLocationStatus(`‚úÖ Automatically checked in to ${lecture.title}! Distance: ${Math.round(distance)}m`, 'success');
            
            // Refresh lectures to update UI
            setTimeout(() => refreshLectures(), 1000);
        } else {
            console.error(`‚ùå Auto check-in failed for ${lecture.title}:`, data.message);
            checkedInLectures.delete(lecture.id); // Allow retry
        }
    })
    .catch(error => {
        console.error(`‚ùå Auto check-in error for ${lecture.title}:`, error);
        checkedInLectures.delete(lecture.id); // Allow retry
    });
}

function showAutoCheckInNotification(lecture, distance) {
    // Create notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show';
    notification.innerHTML = `
        <strong>üéØ Auto Check-in!</strong><br>
        <strong>${lecture.title}</strong><br>
        <small>Distance: ${Math.round(distance)}m ‚Ä¢ ${lecture.course_code}</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(notification, container.firstChild);
    }
    
    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 8000);
}
</script>
{% endblock %}